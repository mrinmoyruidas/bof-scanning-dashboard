<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced BOF Scanning Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        h1 {
            text-align: center;
        }
        #chartsContainer {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }
        .chart {
            border: 1px solid #ddd;
            padding: 10px;
            background: #f9f9f9;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <h1>Enhanced BOF Scanning Dashboard</h1>
    <label for="fileInput">Upload your Excel/JSON file:</label>
    <input type="file" id="fileInput" accept=".xlsx,.xls,.json">
    <br><br>
    <label for="vesselFilter">Filter by Vessel Campaign:</label>
    <select id="vesselFilter" multiple></select>
    <br><br>
    <button id="applyFilter">Apply Filter</button>
    <br><br>
    <div id="chartsContainer">
        <div id="chart1" class="chart"></div>
        <div id="chart2" class="chart"></div>
        <div id="chart3" class="chart"></div>
        <div id="chart4" class="chart"></div>
        <div id="chart5" class="chart"></div>
        <div id="chart6" class="chart"></div>
        <div id="chart7" class="chart"></div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const vesselFilter = document.getElementById('vesselFilter');
        const applyFilter = document.getElementById('applyFilter');
        let jsonData = [];
        let choices;

        // Initialize Choices.js
        function initializeChoices() {
            choices = new Choices(vesselFilter, {
                removeItemButton: true,
                searchEnabled: true,
                placeholder: true,
                placeholderValue: "Select campaigns",
            });
        }

        // Update vessel filter dropdown
        function updateVesselFilterOptions(data) {
            const campaigns = [...new Set(data.map(item => item["Vessel campaign"]))];
            choices.clearChoices(); // Clear previous options
            campaigns.forEach(campaign => {
                choices.setChoices([{ value: campaign, label: campaign }], 'value', 'label', false);
            });
        }

        // Filter data by selected campaigns
        function filterDataByVessel(data) {
            const selectedOptions = choices.getValue(true);
            if (selectedOptions.length === 0) return data; // No filter, return all data
            return data.filter(item => selectedOptions.includes(item["Vessel campaign"]));
        }

        // Generate line chart with proper axis settings
        function generateChart(container, data, xKey, yKey, title) {
            const groupedData = {};
            data.forEach(d => {
                const campaign = d["Vessel campaign"];
                if (!groupedData[campaign]) groupedData[campaign] = { x: [], y: [] };
                groupedData[campaign].x.push(d[xKey]);
                groupedData[campaign].y.push(d[yKey]);
            });

            const traces = Object.keys(groupedData).map(campaign => ({
                x: groupedData[campaign].x,
                y: groupedData[campaign].y,
                mode: 'lines+markers',
                name: campaign,
            }));

            const layout = {
                title: title,
                xaxis: { title: xKey, showline: true, zeroline: true },
                yaxis: { title: yKey, range: [0, 1600], showline: true, zeroline: true }, // Y-axis set to 0 to 1600 mm
                hovermode: 'closest',
            };

            Plotly.newPlot(container, traces, layout);
        }

        // Generate all charts
        function generateCharts(data) {
            generateChart('chart1', data, 'LIFE', 'CHARGE PAD', 'Life vs Charge Pad');
            generateChart('chart2', data, 'LIFE', 'TAP PAD', 'Life vs Tap Pad');
            generateChart('chart3', data, 'LIFE', 'DE Trunnion', 'Life vs DE Trunnion');
            generateChart('chart4', data, 'LIFE', 'NDE Trunnion', 'Life vs NDE Trunnion');
            generateChart('chart5', data, 'LIFE', 'DE Knuckle', 'Life vs DE Knuckle');
            generateChart('chart6', data, 'LIFE', 'NDE Knuckle', 'Life vs NDE Knuckle');
            generateChart('chart7', data, 'LIFE', 'BOTTOM', 'Life vs Bottom');
        }

        // Handle file input and parse data
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        if (file.name.endsWith('.json')) {
                            jsonData = JSON.parse(reader.result);
                        } else {
                            const data = new Uint8Array(reader.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                        }
                        updateVesselFilterOptions(jsonData);
                        generateCharts(jsonData);
                    } catch (error) {
                        alert('Error processing file. Please upload a valid JSON or Excel file.');
                    }
                };
                if (file.name.endsWith('.json')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsArrayBuffer(file);
                }
            }
        });

        // Apply filter and regenerate charts
        applyFilter.addEventListener('click', () => {
            const filteredData = filterDataByVessel(jsonData);
            generateCharts(filteredData);
        });

        // Initialize Choices.js after DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeChoices);
    </script>
</body>
</html>
